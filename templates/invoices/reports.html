{% extends 'base.html' %}
{% load static %}

{% block page_title %}Reports & Analytics{% endblock %}
{% block page_subtitle %}Business insights and financial reports.{% endblock %}

{% block authenticated_content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-rupee-sign"></i></div>
        <div class="stat-info">
            <span class="stat-value">₹{{ total_revenue|floatformat:0 }}</span>
            <span class="stat-label">Total Revenue (YTD)</span>
        </div>
        <div class="stat-trend up"><i class="fas fa-arrow-up"></i> 24%</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
        <div class="stat-info">
            <span class="stat-value">{{ paid_count }}</span>
            <span class="stat-label">Paid Invoices</span>
        </div>
        <div class="stat-trend up"><i class="fas fa-arrow-up"></i> 5%</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
        <div class="stat-info">
            <span class="stat-value">{{ pending_count }}</span>
            <span class="stat-label">Pending Invoices</span>
        </div>
        <div class="stat-trend down"><i class="fas fa-arrow-down"></i> 3%</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-info">
            <span class="stat-value">{{ overdue_count }}</span>
            <span class="stat-label">Overdue Invoices</span>
        </div>
        <div class="stat-trend down"><i class="fas fa-arrow-down"></i> 2%</div>
    </div>
</div>

<div class="content-grid">
    <!-- Monthly Revenue Chart -->
    <section class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> Monthly Revenue Trend</h2>
            <button class="btn-primary"><i class="fas fa-download"></i> Export Report</button>
        </div>
        <div class="chart-container" style="height: 300px;">
            <canvas id="reportChart"></canvas>
        </div>
    </section>

    <!-- Invoice Status Breakdown -->
    <section class="card">
        <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> Invoice Status Distribution</h2>
        </div>
        <div class="chart-container" style="height: 280px;">
            <canvas id="statusChart"></canvas>
        </div>
    </section>

    <!-- Top Clients Revenue -->
    <section class="card">
        <div class="card-header">
            <h2><i class="fas fa-chart-bar"></i> Top Clients Revenue</h2>
        </div>
        <div class="chart-container" style="height: 280px;">
            <canvas id="clientChart"></canvas>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Revenue Bar Chart
    const ctx = document.getElementById('reportChart')?.getContext('2d');
    if (ctx) {
        const monthlyData = [
            {% for item in monthly_revenue %}
            {month: '{{ item.month }}', revenue: {{ item.revenue }}}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthlyData.map(d => d.month),
                datasets: [{
                    label: 'Revenue',
                    data: monthlyData.map(d => d.revenue),
                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                    borderColor: '#6366f1',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '₹' + context.parsed.y.toLocaleString('en-IN');
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false, color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#64748b' } 
                    },
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { 
                            color: '#64748b', 
                            callback: function(v) {
                                return '₹' + (v / 1000).toFixed(0) + 'k';
                            }
                        } 
                    }
                }
            }
        });
    }

    // Status Pie Chart
    const statusCtx = document.getElementById('statusChart')?.getContext('2d');
    if (statusCtx) {
        const statusData = {
            'Paid': {{ status_breakdown.PAID }},
            'Pending': {{ status_breakdown.PENDING }},
            'Overdue': {{ status_breakdown.OVERDUE }},
            'Draft': {{ status_breakdown.DRAFT }}
        };
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: [
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#64748b'
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#94a3b8',
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Top Clients Revenue Chart
    const clientCtx = document.getElementById('clientChart')?.getContext('2d');
    if (clientCtx) {
        const clientData = [
            {% for item in client_revenue %}
            {name: '{{ item.name }}', revenue: {{ item.revenue }}}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        new Chart(clientCtx, {
            type: 'bar',
            data: {
                labels: clientData.map(d => d.name),
                datasets: [{
                    label: 'Revenue',
                    data: clientData.map(d => d.revenue),
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '₹' + context.parsed.x.toLocaleString('en-IN');
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { 
                            color: '#64748b',
                            callback: function(v) {
                                return '₹' + (v / 1000).toFixed(0) + 'k';
                            }
                        } 
                    },
                    y: { 
                        grid: { display: false, color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#64748b' } 
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}

